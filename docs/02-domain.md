# 02 — Domain Model

Документ описывает доменную модель CRM EUREKA:
- ключевые сущности,
- их связи,
- бизнес-правила и инварианты.

Этот файл — источник истины.  
Если что-то противоречит этому документу — значит ошибка в логике.

---

## 1. Принципы доменной модели

1. Система строится вокруг **урока**.
2. Деньги считаются **по факту оплаты**, не по посещаемости.
3. Все бизнес-правила задаются **через курс**.
4. Группа — это реализация курса во времени.

---

## 2. Основные сущности

---

### 2.1 User (Пользователь)

Абстрактная сущность.

Типы:
- Administrator
- Teacher
- Student
- Parent

Общие поля:
- id
- ФИО
- телефон
- email (опционально)
- статус (active / inactive)

Правила:
- один пользователь имеет ровно **одну роль**;
- права определяются ролью, не настройками.

---

### 2.2 Student (Студент)

Расширяет User.

Дополнительные связи:
- состоит в 0..N группах;
- может иметь 0..1 родителя.

Правила:
- студент может обучаться в нескольких группах параллельно;
- ограничения на параллельное обучение задаются курсом.

---

### 2.3 Parent (Родитель)

Расширяет User.

Связи:
- 1 родитель → 1..N студентов;
- студент → 0..1 родитель.

Правила:
- родитель не участвует в учебном процессе;
- родитель имеет только права просмотра.

---

### 2.4 Teacher (Преподаватель)

Расширяет User.

Связи:
- ведёт 0..N групп;
- проводит 0..N уроков.

Правила:
- преподаватель может вести разные курсы;
- замена преподавателя возможна только **на уровне урока**, не группы.

---

## 3. Course (Курс)

Курс — **набор бизнес-правил**.

Поля:
- id
- название
- описание
- тип оплаты студента:
  - per_lesson
  - per_month
  - per_course
- правило пропусков:
  - burn (сгорают)
- тип оплаты преподавателя:
  - per_lesson
  - per_hour
- статус (active / archived)

Правила:
- курс не содержит студентов напрямую;
- курс используется только через группы;
- изменение правил курса **не влияет** на уже проведённые уроки.

---

## 4. Group (Группа)

Группа — это курс, запущенный во времени.

Поля:
- id
- название
- course_id
- teacher_id
- start_date
- end_date (плановая)
- schedule (дни недели + время)
- capacity
- статус (active / completed)

Связи:
- группа → 1 курс
- группа → 1 преподаватель
- группа → 0..N студентов
- группа → 0..N уроков

Правила:
- студент добавляется только в группу;
- группа без курса невозможна;
- закрытая группа не создаёт новых уроков.

---

## 5. Lesson (Урок)

**Ключевая сущность системы.**

Поля:
- id
- group_id
- date
- time_start
- time_end
- teacher_id (может отличаться от группы)
- status:
  - planned
  - completed
  - cancelled

Связи:
- урок → 1 группа
- урок → 1 преподаватель
- урок → 0..N посещений

Правила:
- урок создаётся автоматически из расписания группы;
- урок может быть перенесён или отменён;
- замена преподавателя применяется только к конкретному уроку;
- только проведённый урок учитывается в статистике.

---

## 6. Attendance (Посещаемость)

Связующая сущность: Student ↔ Lesson.

Поля:
- lesson_id
- student_id
- status:
  - present
  - absent

Правила:
- посещаемость фиксируется **только для существующего урока**;
- отсутствие не создаёт долг;
- посещаемость не влияет на факт оплаты.

---

## 7. Payment (Платёж)

Фиксация факта оплаты.

Поля:
- id
- payer_type (student / parent)
- payer_id
- target_type (course / month / package)
- target_reference (идентификатор или текст)
- amount
- date
- comment (опционально)

Правила:
- платёж всегда финальный;
- нет состояний “ожидает” или “частично”;
- платёж не связан напрямую с уроками.

---

## 8. Связи между сущностями (кратко)

- Course → Group (1 → N)
- Group → Lesson (1 → N)
- Group → Student (N ↔ N)
- Lesson → Attendance (1 → N)
- Student → Attendance (1 → N)
- User → Role (1 → 1)

---

## 9. Инварианты системы (нельзя нарушать)

1. Нет урока → нет посещаемости.
2. Нет группы → нет уроков.
3. Нет курса → нет группы.
4. Нет долгов → нет состояний оплаты.
5. Посещаемость не влияет на финансы.
6. Замена преподавателя — только на уровне урока.

---

## 10. Что осознанно исключено из домена

- бонусы преподавателей
- проценты от группы
- рассрочки
- онлайн-занятия
- автоматические блокировки
- финансовые балансы

Все эти вещи — **возможные расширения**, но не часть доменной модели MVP.

---
