@page "{id:guid}"
@model RazorWebApp.Pages.Groups.DetailsModel
@{
    ViewData["Title"] = Model.Group?.Name ?? "Группа";
    var studentsCount = Model.Enrollments.Count;
    var lessonsCount = Model.Lessons.Count;
    var scheduleDays = Model.ScheduleTemplates.Any() 
        ? string.Join(", ", Model.ScheduleTemplates.OrderBy(x => x.DayOfWeek).Select(x => x.DayName))
        : "Не настроено";
    var scheduleTime = Model.ScheduleTemplates.Any() 
        ? Model.ScheduleTemplates.First().StartTime.ToString(@"hh\:mm") + " - " + Model.ScheduleTemplates.First().EndTime.ToString(@"hh\:mm")
        : "";
}

<div class="container-fluid">
    @if (Model.Group != null)
    {
        <div class="row g-3 mb-4">
            <!-- Информация о группе -->
            <div class="col-md-3">
                <div class="nav-card nav-card-primary">
                    <div class="nav-card-header">
                        <a asp-page="/Groups/Index" class="text-decoration-none">
                            <i class="bi bi-arrow-left me-2"></i>@Model.Group.Name
                        </a>
                        <span class="badge @Model.Group.StatusBadgeClass">@Model.Group.StatusName</span>
                    </div>
                    <div class="nav-card-body">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-book text-muted"></i>
                            <span>@Model.Group.CourseName</span>
                        </div>
                    </div>
                    <div class="nav-card-actions">
                        <a asp-page="/Groups/Edit" asp-route-id="@Model.Group.Id" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil"></i> Редактировать
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Журнал -->
            <div class="col-md-3">
                <a asp-page="/Groups/Journal" asp-route-id="@Model.Group.Id" class="nav-card nav-card-link">
                    <div class="nav-card-header">
                        <span><i class="bi bi-journal-text me-2"></i>Журнал</span>
                        <i class="bi bi-chevron-right"></i>
                    </div>
                    <div class="nav-card-body">
                        <div class="text-muted">Посещаемость и оценки</div>
                    </div>
                </a>
            </div>
            
            <!-- Расписание -->
            <div class="col-md-3">
                <a asp-page="/Groups/Details" asp-route-id="@Model.Group.Id" asp-route-tab="schedule" 
                   class="nav-card nav-card-link @(Model.Tab == "schedule" ? "active" : "")">
                    <div class="nav-card-header">
                        <span><i class="bi bi-calendar3 me-2"></i>Расписание</span>
                        <i class="bi bi-chevron-right"></i>
                    </div>
                    <div class="nav-card-body">
                        @if (Model.ScheduleTemplates.Any())
                        {
                            <div>@scheduleDays</div>
                            <div class="text-muted small">@scheduleTime</div>
                        }
                        else
                        {
                            <div class="text-muted">Добавить расписание</div>
                        }
                    </div>
                </a>
            </div>
            
            <!-- Преподаватель -->
            <div class="col-md-3">
                <div class="nav-card">
                    <div class="nav-card-header">
                        <span><i class="bi bi-person-workspace me-2"></i>Преподаватель</span>
                    </div>
                    <div class="nav-card-body">
                        <div class="d-flex align-items-center gap-2">
                            <div class="teacher-avatar">
                                @Model.Group.ResponsibleTeacherName?.Substring(0, 1).ToUpper()
                            </div>
                            <span>@Model.Group.ResponsibleTeacherName</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.Tab == "students" || Model.Tab == null)
        {
            <!-- Таблица студентов -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people me-2"></i>Студенты (@studentsCount)</span>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                        <i class="bi bi-plus"></i> Добавить
                    </button>
                </div>
                <div class="card-body p-0">
                    @if (Model.Enrollments.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="40">#</th>
                                        <th>ФИО</th>
                                        <th>Тип</th>
                                        <th>Зачислен</th>
                                        <th>Статус</th>
                                        <th width="60"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{ var index = 1; }
                                    @foreach (var e in Model.Enrollments)
                                    {
                                        <tr>
                                            <td class="text-muted">@index.</td>
                                            <td class="fw-medium">@e.DisplayName</td>
                                            <td>
                                                @if (e.IsChild)
                                                {
                                                    <span class="badge bg-info-subtle text-info">Ребёнок</span>
                                                    <small class="text-muted ms-1">(@e.ParentName)</small>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-primary-subtle text-primary">Студент</span>
                                                }
                                            </td>
                                            <td>@e.EnrolledAt.ToString("dd.MM.yyyy")</td>
                                            <td><span class="badge bg-success">Активен</span></td>
                                            <td>
                                                <form method="post" asp-page-handler="Unenroll" 
                                                      asp-route-id="@Model.Group.Id" asp-route-enrollmentId="@e.Id"
                                                      onsubmit="return confirm('Отчислить из группы?');">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Отчислить">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        index++;
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-people display-4 text-muted"></i>
                            <h5 class="mt-3 text-muted">Нет студентов в группе</h5>
                            <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                                <i class="bi bi-person-plus"></i> Добавить студента
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
        else if (Model.Tab == "schedule")
        {
            <!-- Расписание -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-calendar-week me-2"></i>Шаблоны расписания</span>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addTemplateModal">
                        <i class="bi bi-plus"></i> Добавить
                    </button>
                </div>
                <div class="card-body">
                    @if (Model.ScheduleTemplates.Any())
                    {
                        <div class="row g-3 mb-4">
                            @foreach (var t in Model.ScheduleTemplates.OrderBy(x => x.DayOfWeek))
                            {
                                <div class="col-md-4">
                                    <div class="schedule-template-card">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">@t.DayName</h6>
                                                <div class="text-muted small">
                                                    <i class="bi bi-clock me-1"></i>@t.StartTime.ToString(@"hh\:mm") - @t.EndTime.ToString(@"hh\:mm")
                                                </div>
                                                @if (!string.IsNullOrEmpty(t.RoomName))
                                                {
                                                    <div class="text-muted small">
                                                        <i class="bi bi-geo-alt me-1"></i>@t.RoomName
                                                    </div>
                                                }
                                            </div>
                                            <form method="post" asp-page-handler="DeleteTemplate">
                                                <input type="hidden" name="id" value="@Model.Group.Id" />
                                                <input type="hidden" name="templateId" value="@t.Id" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                        onclick="return confirm('Удалить шаблон?')" title="Удалить">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <hr />
                        
                        <h6><i class="bi bi-lightning me-2"></i>Генерация занятий</h6>
                        <form method="post" asp-page-handler="GenerateLessons" class="row g-3 align-items-end">
                            <input type="hidden" name="id" value="@Model.Group.Id" />
                            <div class="col-auto">
                                <label class="form-label">С даты</label>
                                <input type="date" name="fromDate" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                            </div>
                            <div class="col-auto">
                                <label class="form-label">По дату</label>
                                <input type="date" name="toDate" class="form-control" value="@DateTime.Today.AddDays(14).ToString("yyyy-MM-dd")" required />
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-calendar-plus"></i> Сгенерировать
                                </button>
                            </div>
                        </form>
                        
                        @if (Model.GeneratedCount.HasValue)
                        {
                            <div class="alert alert-success mt-3">
                                <i class="bi bi-check-circle me-2"></i>Создано занятий: @Model.GeneratedCount
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-calendar3 display-4 text-muted"></i>
                            <h5 class="mt-3 text-muted">Нет шаблонов расписания</h5>
                            <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addTemplateModal">
                                <i class="bi bi-plus"></i> Добавить шаблон
                            </button>
                        </div>
                    }
                </div>
            </div>

            @if (Model.Lessons.Any())
            {
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-journal-text me-2"></i>Ближайшие занятия
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Дата</th>
                                        <th>Время</th>
                                        <th>Статус</th>
                                        <th>Кабинет</th>
                                        <th width="60"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var lesson in Model.Lessons.Take(10))
                                    {
                                        <tr>
                                            <td>@lesson.Date.ToString("dd.MM.yyyy") (@lesson.DayName)</td>
                                            <td>@lesson.StartTime.ToString(@"hh\:mm") - @lesson.EndTime.ToString(@"hh\:mm")</td>
                                            <td><span class="badge @lesson.StatusBadgeClass">@lesson.StatusName</span></td>
                                            <td>@(lesson.RoomName ?? "—")</td>
                                            <td>
                                                @if (lesson.Status == 0)
                                                {
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            data-bs-toggle="modal" data-bs-target="#cancelLessonModal"
                                                            data-lesson-id="@lesson.Id" title="Отменить">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            
            <div class="mt-3">
                <a asp-page="/Groups/Details" asp-route-id="@Model.Group.Id" asp-route-tab="students" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Назад к студентам
                </a>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">Группа не найдена</div>
    }
</div>

<!-- Модальное окно добавления студента -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Enroll">
                <input type="hidden" name="id" value="@Model.Group?.Id" />
                <div class="modal-header">
                    <h5 class="modal-title">Добавить в группу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#student-pane" type="button">Студент</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#child-pane" type="button">Ребёнок</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="student-pane">
                            <select name="studentId" class="form-select">
                                <option value="">— Выберите студента —</option>
                                @foreach (var s in Model.AvailableStudents)
                                {
                                    <option value="@s.Id">@s.FullName (@s.Phone)</option>
                                }
                            </select>
                        </div>
                        <div class="tab-pane fade" id="child-pane">
                            <select name="childId" class="form-select">
                                <option value="">— Выберите ребёнка —</option>
                                @foreach (var c in Model.AvailableChildren)
                                {
                                    <option value="@c.Id">@c.FullName (@c.ParentName)</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно добавления шаблона расписания -->
<div class="modal fade" id="addTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="AddTemplate">
                <input type="hidden" name="id" value="@Model.Group?.Id" />
                <div class="modal-header">
                    <h5 class="modal-title">Добавить расписание</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">День недели</label>
                        <select name="dayOfWeek" class="form-select" required>
                            <option value="1">Понедельник</option>
                            <option value="2">Вторник</option>
                            <option value="3">Среда</option>
                            <option value="4">Четверг</option>
                            <option value="5">Пятница</option>
                            <option value="6">Суббота</option>
                            <option value="0">Воскресенье</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Начало</label>
                            <input type="time" name="startTime" class="form-control" value="10:00" required />
                        </div>
                        <div class="col-6">
                            <label class="form-label">Конец</label>
                            <input type="time" name="endTime" class="form-control" value="11:30" required />
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Кабинет</label>
                        <select name="roomId" class="form-select">
                            <option value="">Не выбран</option>
                            @foreach (var r in Model.Rooms)
                            {
                                <option value="@r.Id">@r.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно отмены занятия -->
<div class="modal fade" id="cancelLessonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="CancelLesson">
                <input type="hidden" name="id" value="@Model.Group?.Id" />
                <input type="hidden" name="lessonId" id="cancelLessonId" />
                <div class="modal-header">
                    <h5 class="modal-title">Отменить занятие</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Причина отмены</label>
                    <textarea name="reason" class="form-control" rows="3" placeholder="Укажите причину..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="submit" class="btn btn-danger">Отменить занятие</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById('cancelLessonModal')?.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        document.getElementById('cancelLessonId').value = button.getAttribute('data-lesson-id');
    });
</script>
}
