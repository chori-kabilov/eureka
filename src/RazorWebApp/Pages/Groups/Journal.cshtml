@page "{id:guid}"
@model RazorWebApp.Pages.Groups.JournalModel
@{
    ViewData["Title"] = "Журнал - " + (Model.Group?.Name ?? "Группа");
    
    var lessonsByWeek = Model.Lessons
        .GroupBy(l => System.Globalization.ISOWeek.GetWeekOfYear(l.Date))
        .OrderByDescending(g => g.Key)
        .ToList();
    
    var currentWeek = System.Globalization.ISOWeek.GetWeekOfYear(DateTime.Today);
}

<div class="container-fluid">
    @if (Model.Group != null)
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a asp-page="/Groups/Details" asp-route-id="@Model.Group.Id" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h2 class="mb-0">Journal</h2>
                    <div class="text-muted">@Model.Group.Name</div>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="btnSendResults">
                <i class="bi bi-send me-1"></i> SEND RESULTS
            </button>
        </div>

        @if (Model.Journal.Any() && Model.Lessons.Any())
        {
            <div class="accordion" id="journalAccordion">
                @foreach (var weekGroup in lessonsByWeek)
                {
                    var weekNum = weekGroup.Key;
                    var weekLessons = weekGroup.OrderBy(l => l.Date).ToList();
                    var isCurrentWeek = weekNum == currentWeek;
                    var weekId = $"week{weekNum}";
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button @(isCurrentWeek ? "" : "collapsed")" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#@weekId">
                                Week @weekNum
                            </button>
                        </h2>
                        <div id="@weekId" class="accordion-collapse collapse @(isCurrentWeek ? "show" : "")" 
                             data-bs-parent="#journalAccordion">
                            <div class="accordion-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-bordered mb-0 journal-week-table">
                                        <thead>
                                            <tr>
                                                <th class="sticky-student" rowspan="2">STUDENTS</th>
                                                @foreach (var lesson in weekLessons)
                                                {
                                                    <th colspan="2" class="text-center lesson-header">
                                                        @lesson.Date.ToString("dd.MM.yyyy")
                                                    </th>
                                                }
                                                <th colspan="3" class="text-center end-week-header">END OF WEEK</th>
                                            </tr>
                                            <tr>
                                                @foreach (var lesson in weekLessons)
                                                {
                                                    <th class="text-center sub-header">Att</th>
                                                    <th class="text-center sub-header">Score</th>
                                                }
                                                <th class="text-center sub-header">Bonus</th>
                                                <th class="text-center sub-header">Exam</th>
                                                <th class="text-center sub-header sum-header">Sum</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{ var rowIndex = 1; }
                                            @foreach (var student in Model.Journal)
                                            {
                                                <tr>
                                                    <td class="sticky-student">
                                                        @rowIndex. @student.StudentName
                                                    </td>
                                                    @foreach (var lesson in weekLessons)
                                                    {
                                                        var cell = student.Cells.FirstOrDefault(c => c.LessonId == lesson.Id);
                                                        var isPresent = cell?.AttendanceStatus == 0;
                                                        var isAbsent = cell?.AttendanceStatus == 1;
                                                        var isLate = cell?.AttendanceStatus == 2;
                                                        
                                                        <td class="text-center att-cell">
                                                            <input type="checkbox" class="form-check-input att-checkbox" 
                                                                   @(isPresent ? "checked" : "") 
                                                                   data-lesson="@lesson.Id"
                                                                   data-student="@student.StudentId"
                                                                   data-child="@student.ChildId" />
                                                        </td>
                                                        <td class="text-center score-cell">
                                                            <select class="form-select form-select-sm score-select"
                                                                    data-lesson="@lesson.Id"
                                                                    data-student="@student.StudentId"
                                                                    data-child="@student.ChildId">
                                                                <option value="">—</option>
                                                                @for (int i = 1; i <= 5; i++)
                                                                {
                                                                    if (cell?.Grade == i)
                                                                    {
                                                                        <option value="@i" selected>@i</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@i">@i</option>
                                                                    }
                                                                }
                                                            </select>
                                                        </td>
                                                    }
                                                    <td class="text-center bonus-cell">
                                                        <input type="checkbox" class="form-check-input" />
                                                    </td>
                                                    <td class="text-center exam-cell">
                                                        <input type="checkbox" class="form-check-input" />
                                                    </td>
                                                    <td class="text-center sum-cell">
                                                        @{
                                                            var weekCells = student.Cells.Where(c => weekLessons.Any(l => l.Id == c.LessonId)).ToList();
                                                            var avgScore = weekCells.Where(c => c.Grade.HasValue).Select(c => c.Grade!.Value).DefaultIfEmpty(0).Average();
                                                            var attendanceCount = weekCells.Count(c => c.AttendanceStatus == 0);
                                                            var percent = weekCells.Any() ? (int)(attendanceCount * 100.0 / weekCells.Count) : 0;
                                                        }
                                                        <span class="badge @(percent >= 80 ? "bg-success" : percent >= 50 ? "bg-warning text-dark" : "bg-danger")">
                                                            @percent%
                                                        </span>
                                                    </td>
                                                </tr>
                                                rowIndex++;
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (!Model.Journal.Any())
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-people display-4 text-muted"></i>
                    <h5 class="mt-3 text-muted">Нет студентов в группе</h5>
                    <a asp-page="/Groups/Details" asp-route-id="@Model.Group.Id" class="btn btn-primary mt-2">
                        <i class="bi bi-person-plus"></i> Добавить студентов
                    </a>
                </div>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-calendar-x display-4 text-muted"></i>
                    <h5 class="mt-3 text-muted">Нет занятий</h5>
                    <a asp-page="/Groups/Details" asp-route-id="@Model.Group.Id" asp-route-tab="schedule" class="btn btn-primary mt-2">
                        <i class="bi bi-calendar-plus"></i> Создать расписание
                    </a>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">Группа не найдена</div>
    }
</div>

<style>
.journal-week-table {
    font-size: 13px;
}

.journal-week-table th {
    background: #f8f9fa;
    font-weight: 600;
    white-space: nowrap;
}

.sticky-student {
    position: sticky;
    left: 0;
    background: white;
    z-index: 1;
    min-width: 180px;
    border-right: 2px solid var(--primary-color) !important;
}

thead .sticky-student {
    background: #f8f9fa;
    z-index: 2;
}

.lesson-header {
    background: #e9ecef !important;
    min-width: 120px;
}

.end-week-header {
    background: #fff3cd !important;
    color: #856404;
}

.sub-header {
    font-size: 11px;
    text-transform: uppercase;
    color: #6c757d;
    padding: 4px 8px !important;
}

.sum-header {
    background: #d4edda !important;
    color: #155724;
}

.att-cell, .score-cell, .bonus-cell, .exam-cell {
    padding: 4px !important;
    vertical-align: middle;
}

.att-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.att-checkbox:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.score-select {
    width: 50px;
    padding: 2px 4px;
    font-size: 12px;
}

.sum-cell {
    background: #f8f9fa;
}

.accordion-button:not(.collapsed) {
    background-color: var(--primary-light);
    color: var(--primary-color);
}

.accordion-button {
    font-weight: 600;
}
</style>

@section Scripts {
<script>
document.querySelectorAll('.att-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', async function() {
        const lessonId = this.dataset.lesson;
        const studentId = this.dataset.student || null;
        const childId = this.dataset.child || null;
        const status = this.checked ? 0 : 1;
        
        try {
            await fetch(`/api/v1/journal/lessons/${lessonId}/attendance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentId, childId, status })
            });
        } catch (e) {
            console.error('Error saving attendance', e);
        }
    });
});

document.querySelectorAll('.score-select').forEach(select => {
    select.addEventListener('change', async function() {
        const lessonId = this.dataset.lesson;
        const studentId = this.dataset.student || null;
        const childId = this.dataset.child || null;
        const score = this.value ? parseInt(this.value) : null;
        
        try {
            await fetch(`/api/v1/journal/lessons/${lessonId}/grades`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ studentId, childId, score, weight: 1 })
            });
        } catch (e) {
            console.error('Error saving grade', e);
        }
    });
});

document.getElementById('btnSendResults')?.addEventListener('click', function() {
    alert('Результаты отправлены!');
});
</script>
}
